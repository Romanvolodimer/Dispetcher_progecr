# =================================================================
# 1. –ë–∞–∑–æ–≤–∏–π –æ–±—Ä–∞–∑
# =================================================================
FROM node:20-slim

# =================================================================
# 2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π Chromium
#    –í—Å—Ç–∞–Ω–æ–≤–ª—é—î —Å–∞–º Chromium —Ç–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –¥–ª—è –π–æ–≥–æ —Ä–æ–±–æ—Ç–∏
# =================================================================
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞–∫–µ—Ç—É Chromium
        chromium \
        # –ö–ª—é—á–æ–≤—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ, —è–∫—ñ –º–æ–∂—É—Ç—å –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—è, —è–∫—â–æ –Ω–µ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
        libgbm1 \
        libnss3 \
        libatk-bridge2.0-0 \
        libgtk-3-0 \
        libasound2 \
        # –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–µ—à—É apt –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —à–∞—Ä—É
    && rm -rf /var/lib/apt/lists/*

# =================================================================
# 3. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Puppeteer —Ç–∞ –û—Ç–æ—á–µ–Ω–Ω—è
# =================================================================
# üí° –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–Ω–∏–π Chromium
ENV PUPPETEER_SKIP_DOWNLOAD=true
# üí° –®–ª—è—Ö –¥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ Chromium
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
# üí° –ü–æ—Ä—Ç: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Node/Express
ENV PORT=3000

# =================================================================
# 4. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π Node.js
# =================================================================
WORKDIR /app

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ª–∏—à–µ —Ñ–∞–π–ª—ñ–≤ package –¥–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è —à–∞—Ä—É
COPY package*.json ./
# üí° –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 'npm ci' –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ç–∞ —á–∏—Å—Ç–æ–≥–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
RUN npm ci --only=production

# =================================================================
# 5. –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–æ–¥—É, –ü–æ—Ä—Ç —Ç–∞ –ó–∞–ø—É—Å–∫
# =================================================================
COPY . .

# –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ—Ä—Ç—É (—ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–π)
EXPOSE 3000

# üí° –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫—É –≥–æ–ª–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª—É –≤–∞—à–æ–≥–æ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É
CMD ["node", "server.js"]