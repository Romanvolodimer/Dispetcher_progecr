<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>–í–≤–µ–¥–µ–Ω–Ω—è –î–∞–Ω–∏—Ö –£—Å—Ç–∞–Ω–æ–≤–∫–∏</title>
    <style>
        /* ==================================== */
        /* –°–¢–ò–õ–Ü CSS                            */
        /* ==================================== */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        /* –í–∏–±—ñ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        #installation-selection {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
        }

        .install-btn {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        .install-btn.active,
        .install-btn:hover {
            background-color: #007bff;
            color: white;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä */
        #calendar-view {
            max-width: 800px;
            margin: 0 auto 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        #calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        #month-year-display {
            font-size: 1.5em;
            margin: 0;
            color: #007bff;
        }

        #calendar-controls button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        #calendar-controls button:hover {
            background-color: #e0e0e0;
        }

        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
            text-align: center;
        }

        .day-name {
            font-weight: bold;
            padding: 10px 5px;
            color: #333;
        }

        .calendar-day {
            padding: 15px 5px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: #f9f9f9;
            border-radius: 3px;
            transition: background-color 0.2s;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.05);
        }

        .calendar-day:hover {
            background-color: #e9ecef;
            border-color: #007bff;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—å–æ–≥–æ –¥–Ω—è */
        .calendar-day.today {
            background-color: #ffc107;
            color: #333;
            font-weight: bold;
            border-color: #e0a800;
            box-shadow: 0 0 5px rgba(255, 193, 7, 0.7);
        }

        .calendar-day.today:hover {
            background-color: #e0a800;
            color: white;
        }


        /* –ú–æ–¥–∞–ª—å–Ω–µ –í—ñ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        #input-fields-container {

            width: 237px;

            margin-top: 20px;
            overflow-y: auto;
            padding-right: 15px;
        }




        .input-hour-group {
            display: flex;
            width: 150px;
            align-items: center;
        }

        .input-hour-label {
            font-weight: bold;
            margin-right: 5px;
            width: 25px;
            text-align: right;
            padding-bottom: 2px;
        }

        #input-fields-container input {
            flex-grow: 1;

            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .button-group {
            text-align: right;
            margin-top: 20px;
        }

        #save-button {
            padding: 10px 25px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #save-button:hover {
            background-color: #1e7e34;
        }

        #save-status-message {
            font-weight: bold;
            margin-top: 10px;
        }

        .form-container {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
    </style>
</head>

<body>

    <header>
        <h1 id="calendar-header">–û–±–µ—Ä—ñ—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É</h1>
    </header>

    <div id="main-content">
        <section id="installation-selection">
            <button class="install-btn" data-name="–ö–ì–£1" onclick="selectInstallation('–ö–ì–£1')">–ï–Ω–µ–π</button>
            <button class="install-btn" data-name="–ö–ì–£2" onclick="selectInstallation('–ö–ì–£2')">–£–Ω—ñ–ø–ª–∏—Ç</button>
            <button class="install-btn" data-name="–ö–ì–£3" onclick="selectInstallation('–ö–ì–£3')">–ö–∞—à—Ç–∞–Ω</button>

        </section>
        <div>
            <button onclick="backToMain()">–ù–∞–∑–∞–¥</button>
        </div>
        <section id="calendar-view" style="display: none;">
            <div id="calendar-controls">
                <button onclick="changeMonth(-1)">&#9664; –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π</button>
                <h2 id="month-year-display"></h2>
                <button onclick="changeMonth(1)">–ù–∞—Å—Ç—É–ø–Ω–∏–π &#9654;</button>
            </div>
            <div id="calendar-grid">
            </div>
        </section>
    </div>

    <div id="data-entry-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDataEntryWindow()">&times;</span>
            <h2 id="modal-date-header"></h2>

            <form class="form-container" id="data-entry-form">
                <div id="input-fields-container">
                </div>

                <p id="save-status-message" style="display: none;"></p>

                <div class="button-group">
                    <div class="form-field">
                        <label for="capacity-input">–†–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (–ú–í—Ç)</label>
                        <input type="number" id="capacity-input" name="capacity" value="1" min="1" required>
                    </div>

                    <button type="submit" id="save-button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>

    <script>

        function backToMain() {
            window.location.href = 'index.html';
        }



        /* ==================================== */
        /* –§–£–ù–ö–¶–Ü–û–ù–ê–õ JS                        */
        /* ==================================== */
        let selectedInstallation = null;
        let currentSelectedDate = null;
        let currentDate = new Date(); // –í—ñ–¥—Å—Ç–µ–∂—É—î, —è–∫–∏–π –º—ñ—Å—è—Ü—å/—Ä—ñ–∫ –º–∏ –ø–æ–∫–∞–∑—É—î–º–æ
        const MONTH_NAMES = ["–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å",
            "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"];


        // --- 1. –í–∏–±—ñ—Ä –£—Å—Ç–∞–Ω–æ–≤–∫–∏ ---
        function selectInstallation(name) {
            selectedInstallation = name;
            document.getElementById('calendar-header').textContent = `–£—Å—Ç–∞–Ω–æ–≤–∫–∞: ${name}`;

            document.querySelectorAll('.install-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const selectedButton = document.querySelector(`.install-btn[data-name="${name}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            document.getElementById('calendar-view').style.display = 'block';
            generateCalendar();
        }

        // --- 2.1. –ó–º—ñ–Ω–∞ –ú—ñ—Å—è—Ü—è ---
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
        }

        // --- 2.2. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ö–∞–ª–µ–Ω–¥–∞—Ä—è ---
        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            document.getElementById('month-year-display').textContent =
                `${MONTH_NAMES[month]} ${year}`;

            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';

            const daysOfWeek = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–ù–¥'];
            daysOfWeek.forEach(dayName => {
                const header = document.createElement('div');
                header.textContent = dayName;
                header.classList.add('day-name');
                calendarGrid.appendChild(header);
            });

            let startDay = firstDayOfMonth.getDay();
            let offset = startDay === 0 ? 6 : startDay - 1;

            for (let i = 0; i < offset; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const monthString = String(month + 1).padStart(2, '0');
                const dayString = String(day).padStart(2, '0');
                const dateString = `${year}-${monthString}-${dayString}`;

                const dayElement = document.createElement('div');
                dayElement.textContent = day;
                dayElement.classList.add('calendar-day');

                // –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—å–æ–≥–æ –¥–Ω—è
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayElement.classList.add('today');
                }

                dayElement.onclick = () => openDataEntryWindow(dateString);
                calendarGrid.appendChild(dayElement);
            }
        }

        // --- 3.1. –ó–∞–ø–∏—Ç –¥–∞–Ω–∏—Ö –∑ –±–µ–∫–µ–Ω–¥—É (GET) ---
        async function fetchExistingData(installation, date) {
            try {
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ –≤–∞—à –º–∞—Ä—à—Ä—É—Ç /api/get-data
                const response = await fetch(`/api/get-data?installation=${installation}&date=${date}`);
                const result = await response.json();

                if (response.ok && result.success) {
                    return result.data;
                } else {
                    console.warn("–î–∞–Ω—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –ø–æ–º–∏–ª–∫–∞ –±–µ–∫–µ–Ω–¥—É:", result.message);
                    return [];
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö:', error);
                return [];
            }
        }

        // --- 3.2. –í—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ ---
        async function openDataEntryWindow(date) {
            if (!selectedInstallation) {
                alert("–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É!");
                return;
            }

            currentSelectedDate = date;
            const modal = document.getElementById('data-entry-modal');
            const statusMessage = document.getElementById('save-status-message');

            document.getElementById('modal-date-header').textContent = `–í–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö (${selectedInstallation}) –∑–∞: ${date}`;
            statusMessage.style.display = 'none'; // –°–∫–∏–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Å—Ç–∞—Ç—É—Å

            const container = document.getElementById('input-fields-container');
            container.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...';

            // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–∏—Ö –¥–∞–Ω–∏—Ö
            const existingData = await fetchExistingData(selectedInstallation, date);
            container.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è..."

            // 2. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è 24 –ø–æ–ª—ñ–≤ –≤–≤–æ–¥—É
            for (let i = 1; i <= 24; i++) {
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è, –∞–±–æ –ø—É—Å—Ç–∞ —Å—Ç—Ä–æ–∫–∞
                const record = existingData.find(r => r.hour_of_day == i);
                const initialValue = record ? record.value : '';

                const div = document.createElement('div');
                div.classList.add('input-hour-group');
                const hourLabel = String(i).padStart(2, '0');

                div.innerHTML = `
                    <span class="input-hour-label">${hourLabel}:</span> 
                    <input type="number" id="input-${i}" name="hour${i}" min="0" required value="${initialValue}">
                `;
                container.appendChild(div);
            }

            modal.style.display = 'block';
        }

        function closeDataEntryWindow() {
            document.getElementById('data-entry-modal').style.display = 'none';
        }

        // --- 4. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –î–∞–Ω–∏—Ö —Ç–∞ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–ª—ñ–≤ ---
        async function saveData(event) {
            event.preventDefault(); // –ó—É–ø–∏–Ω—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –≤—ñ–¥–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º–∏

            const statusMessage = document.getElementById('save-status-message');
            statusMessage.style.display = 'block';
            statusMessage.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
            statusMessage.style.color = 'orange';

            const values = {};
            let isDataValid = true;

            for (let i = 1; i <= 24; i++) {
                const input = document.getElementById(`input-${i}`);
                if (!input || input.value.trim() === '' || isNaN(input.value)) {
                    isDataValid = false;
                    input.style.borderColor = 'red';
                    break;
                }
                input.style.borderColor = '#ccc'; // –°–∫–∏–¥–∞—î–º–æ –∫–æ–ª—ñ—Ä
                values[`hour${i}`] = input.value;
            }

            if (!isDataValid) {
                statusMessage.textContent = '–ü–æ–º–∏–ª–∫–∞: –£—Å—ñ 24 –ø–æ–ª—è –º–∞—é—Ç—å –±—É—Ç–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –∫–æ—Ä–µ–∫—Ç–Ω–∏–º–∏ —á–∏—Å–ª–∞–º–∏!';
                statusMessage.style.color = 'red';
                return;
            }

            const capacityInput = document.getElementById('capacity-input');
            const capacityValue = capacityInput ? capacityInput.value : 1; // –ó–∞—Ö–∏—Å—Ç –Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ –ø–æ–ª–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

            const payload = {
                installation: selectedInstallation,
                date: currentSelectedDate,
                values: values,
                capacity: capacityValue // ‚úÖ –¢–ï–ü–ï–† –í–û–ù–û –¢–£–¢!
            };

            try {
                // 1. –ù–∞–¥—Å–∏–ª–∞—î–º–æ POST-–∑–∞–ø–∏—Ç –Ω–∞ –±–µ–∫–µ–Ω–¥
                const response = await fetch('/api/save-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    statusMessage.textContent = '‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!';
                    statusMessage.style.color = 'green';

                    // 2. üí° –ü–û–í–¢–û–†–ù–û –ó–ê–í–ê–ù–¢–ê–ñ–£–Ñ–ú–û –î–ê–ù–Ü –î–õ–Ø –û–ù–û–í–õ–ï–ù–ù–Ø –ü–û–õ–Ü–í
                    // –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è —Å–∞–º–µ —Ç—ñ –¥–∞–Ω—ñ, —è–∫—ñ –ë–î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–ª–∞.
                    await updateFieldsAfterSave();

                } else {
                    statusMessage.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${result.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞.'}`;
                    statusMessage.style.color = 'red';
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ:', error);
                statusMessage.textContent = '‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä.';
                statusMessage.style.color = 'red';
            }
        }

        // --- 5. –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–ª—ñ–≤ –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ---
        async function updateFieldsAfterSave() {
            if (!currentSelectedDate || !selectedInstallation) return;

            const existingData = await fetchExistingData(selectedInstallation, currentSelectedDate);

            // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –ø–æ–ª—è –≤–≤–æ–¥—É
            for (let i = 1; i <= 24; i++) {
                const input = document.getElementById(`input-${i}`);
                if (input) {
                    const record = existingData.find(r => r.hour_of_day == i);
                    input.value = record ? record.value : '';
                    input.style.borderColor = '#ccc'; // –û—á–∏—â–∞—î–º–æ –±—É–¥—å-—è–∫–µ —á–µ—Ä–≤–æ–Ω–µ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
                }
            }
        }

        // --- 6. Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('data-entry-form');
            if (form) {
                form.addEventListener('submit', saveData);
            }
            generateCalendar();
        });

        window.onclick = function (event) {
            const modal = document.getElementById('data-entry-modal');
            if (event.target === modal) {
                closeDataEntryWindow();
            }
        }
    </script>
</body>

</html>